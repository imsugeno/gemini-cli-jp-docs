# Gemini CLI コア

Gemini CLI のコアパッケージ (`packages/core`) は、Gemini CLI のバックエンド部分であり、Gemini API との通信、ツールの管理、`packages/cli` から送信されたリクエストの処理を担当します。Gemini CLI の一般的な概要については、[メインのドキュメントページ](../index.md) を参照してください。

## このセクションのナビゲート

- **[コアツール API](./tools-api.md):** コアによるツールの定義、登録、使用方法に関する情報。

## コアの役割

Gemini CLI の `packages/cli` 部分がユーザーインターフェイスを提供するのに対し、`packages/core` は次の責任を負います。

- **Gemini API との対話:** Google Gemini API と安全に通信し、ユーザープロンプトを送信し、モデルの応答を受信します。
- **プロンプトエンジニアリング:** Gemini モデルの効果的なプロンプトを構築します。これには、会話履歴、ツール定義、`GEMINI.md` ファイルからの指示コンテキストが組み込まれる可能性があります。
- **ツールの管理とオーケストレーション:**
  - 利用可能なツール (ファイルシステムツール、シェルコマンド実行など) を登録します。
  - Gemini モデルからのツール使用リクエストを解釈します。
  - 提供された引数で要求されたツールを実行します。
  - さらなる処理のためにツール実行結果を Gemini モデルに返します。
- **セッションと状態の管理:** 履歴や、一貫した対話に必要な関連コンテキストなど、会話の状態を追跡します。
- **構成:** API キーアクセス、モデル選択、ツール設定など、コア固有の構成を管理します。

## セキュリティに関する考慮事項

コアはセキュリティにおいて重要な役割を果たします。

- **API キー管理:** `GEMINI_API_KEY` を処理し、Gemini API との通信時に安全に使用されるようにします。
- **ツールの実行:** ツールがローカルシステムと対話する場合 (例: `run_shell_command`)、コア (およびその基盤となるツール実装) は、意図しない変更を防ぐためにサンドボックスメカニズムを伴うことが多い、適切な注意を払って行う必要があります。

## チャット履歴の圧縮

長い会話が Gemini モデルのトークン制限を超えないようにするために、コアにはチャット履歴圧縮機能が含まれています。

会話が構成済みモデルのトークン制限に近づくと、コアはモデルに送信する前に会話履歴を自動的に圧縮します。この圧縮は、伝達される情報の観点からはロスレスになるように設計されていますが、使用されるトークンの総数を削減します。

各モデルのトークン制限は、[Google AI ドキュメント](https://ai.google.dev/gemini-api/docs/models) で確認できます。

## モデルのフォールバック

Gemini CLI には、デフォルトの「pro」モデルがレート制限されていても CLI を引き続き使用できるようにするためのモデルフォールバックメカニズムが含まれています。

デフォルトの「pro」モデルを使用していて、CLI がレート制限されていることを検出した場合、現在のセッションでは自動的に「flash」モデルに切り替わります。これにより、中断することなく作業を続けることができます。

## ファイル検出サービス

ファイル検出サービスは、現在のコンテキストに関連するプロジェクト内のファイルを検索する責任があります。`@` コマンドやファイルにアクセスする必要があるその他のツールで使用されます。

## メモリ検出サービス

メモリ検出サービスは、モデルにコンテキストを提供する `GEMINI.md` ファイルを検索して読み込む責任があります。現在の作業ディレクトリから開始し、プロジェクトのルートとユーザーのホームディレクトリまで階層的にこれらのファイルを検索します。また、サブディレクトリも検索します。

これにより、グローバル、プロジェクトレベル、およびコンポーネントレベルのコンテキストファイルを持つことができ、これらすべてが組み合わされて、モデルに最も関連性の高い情報が提供されます。

[`/memory` コマンド](../cli/commands.md) を使用して、読み込まれた `GEMINI.md` ファイルの内容を `show`、`add`、`refresh` できます。