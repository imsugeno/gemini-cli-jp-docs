# Gemini CLI の実行とデプロイ

このドキュメントでは、Gemini CLI の実行方法と、Gemini CLI が使用するデプロイアーキテクチャについて説明します。

## Gemini CLI の実行

Gemini CLI を実行するにはいくつかの方法があります。選択するオプションは、Gemini CLI をどのように使用する予定かによって異なります。

---

### 1. 標準インストール (一般的なユーザーに推奨)

これは、エンドユーザーが Gemini CLI をインストールするための推奨される方法です。NPM レジストリから Gemini CLI パッケージをダウンロードします。

- **グローバルインストール:**

  ```bash
  # CLI をグローバルにインストールする
  npm install -g @google/gemini-cli

  # これでどこからでも CLI を実行できます
  gemini
  ```

- **NPX 実行:**
  ```bash
  # グローバルインストールなしで NPM から最新バージョンを実行する
  npx @google/gemini-cli
  ```

---

### 2. サンドボックスでの実行 (Docker/Podman)

セキュリティと分離のために、Gemini CLI はコンテナ内で実行できます。これは、副作用をもたらす可能性のあるツールを CLI が実行するデフォルトの方法です。

- **レジストリから直接:**
  公開されているサンドボックスイメージを直接実行できます。これは、Docker しかなく、CLI を実行したい環境で役立ちます。
  ```bash
  # 公開されているサンドボックスイメージを実行する
  docker run --rm -it us-docker.pkg.dev/gemini-code-dev/gemini-cli/sandbox:0.1.1
  ```
- **`--sandbox` フラグの使用:**
  Gemini CLI をローカルにインストールしている場合 (上記の標準インストールを使用)、サンドボックスコンテナ内で実行するように指示できます。
  ```bash
  gemini --sandbox "ここにプロンプトを入力"
  ```

---

### 3. ソースからの実行 (Gemini CLI の貢献者に推奨)

プロジェクトの貢献者は、ソースコードから直接 CLI を実行したいと思うでしょう。

- **開発モード:**
  この方法はホットリロードを提供し、アクティブな開発に役立ちます。
  ```bash
  # リポジトリのルートから
  npm run start
  ```
- **本番に近いモード (リンクされたパッケージ):**
  この方法は、ローカルパッケージをリンクすることでグローバルインストールをシミュレートします。本番ワークフローでローカルビルドをテストするのに役立ちます。

  ```bash
  # ローカル cli パッケージをグローバル node_modules にリンクする
  npm link packages/cli

  # これで `gemini` コマンドを使用してローカルバージョンを実行できます
  gemini
  ```

---

### 4. GitHub から最新の Gemini CLI コミットを実行する

GitHub リポジトリから直接、最新のコミット済みバージョンの Gemini CLI を実行できます。これは、まだ開発中の機能をテストするのに役立ちます。

```bash
# GitHub の main ブランチから直接 CLI を実行する
npx https://github.com/google/gemini-cli
```

## デプロイアーキテクチャ

上記で説明した実行方法は、次のアーキテクチャコンポーネントとプロセスによって可能になります。

**NPM パッケージ**

Gemini CLI プロジェクトは、2 つのコアパッケージを NPM レジストリに公開するモノレポです。

- `@google/gemini-cli-core`: ロジックとツールの実行を処理するバックエンド。
- `@google/gemini-cli`: ユーザー向けのフロントエンド。

これらのパッケージは、標準インストールを実行するとき、およびソースから Gemini CLI を実行するときに使用されます。

**ビルドとパッケージングのプロセス**

配布チャネルに応じて、2 つの異なるビルドプロセスが使用されます。

- **NPM 公開:** NPM レジストリに公開するために、`@google/gemini-cli-core` と `@google/gemini-cli` の TypeScript ソースコードは、TypeScript コンパイラ (`tsc`) を使用して標準の JavaScript にトランスパイルされます。結果の `dist/` ディレクトリが NPM パッケージで公開されるものです。これは、TypeScript ライブラリの標準的なアプローチです。

- **GitHub `npx` 実行:** GitHub から直接最新バージョンの Gemini CLI を実行すると、`package.json` の `prepare` スクリプトによって別のプロセスがトリガーされます。このスクリプトは `esbuild` を使用して、アプリケーション全体とその依存関係を単一の自己完結型 JavaScript ファイルにバンドルします。このバンドルはユーザーのマシンでオンザフライで作成され、リポジトリにはチェックインされません。

**Docker サンドボックスイメージ**

Docker ベースの実行方法は、`gemini-cli-sandbox` コンテナイメージによってサポートされています。このイメージはコンテナレジストリに公開され、事前にインストールされたグローバルバージョンの Gemini CLI が含まれています。`scripts/prepare-cli-packagejson.js` スクリプトは、公開前にこのイメージの URI を CLI の `package.json` に動的に挿入するため、`--sandbox` フラグが使用されたときに CLI がどのイメージをプルするかを認識します。

## リリースプロセス

統合スクリプト `npm run publish:release` がリリースプロセスを調整します。スクリプトは次のアクションを実行します。

1.  `tsc` を使用して NPM パッケージをビルドします。
2.  CLI の `package.json` を Docker イメージ URI で更新します。
3.  `gemini-cli-sandbox` Docker イメージをビルドしてタグ付けします。
4.  Docker イメージをコンテナレジストリにプッシュします。
5.  NPM パッケージをアーティファクトレジストリに公開します。